{% extends "base.html" %}

{% block title %}Execution History — {{ kit.name }} — CLERK{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Breadcrumb -->
    <nav class="text-sm text-muted-foreground mb-6">
        <a href="/" class="hover:text-foreground transition-colors">Kits</a>
        <span class="mx-2">/</span>
        <a href="/kit/{{ kit.slug }}" class="hover:text-foreground transition-colors">{{ kit.name }}</a>
        <span class="mx-2">/</span>
        <span class="text-foreground">History</span>
    </nav>

    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold tracking-tight">Execution History</h1>
            <p class="text-muted-foreground mt-1">Past runs of <strong>{{ kit.name }}</strong></p>
        </div>
        <div class="flex items-center gap-3">
            <a href="/kit/{{ kit.slug }}/run" class="btn btn-primary">Run Kit</a>
            <a href="/kit/{{ kit.slug }}" class="btn btn-secondary">Back to Kit</a>
        </div>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="empty-state">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <span class="pulse-dot"></span>
            <span class="pulse-dot"></span>
            <span class="pulse-dot"></span>
        </div>
        <p class="text-sm mt-3">Loading execution history...</p>
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="empty-state" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <p class="text-lg mb-1 font-medium">No executions yet</p>
        <p class="text-sm">Run this kit to see your execution history here.</p>
        <a href="/kit/{{ kit.slug }}/run" class="btn btn-primary mt-4" style="display: inline-flex;">Run Kit</a>
    </div>

    <!-- Error state -->
    <div id="error-state" class="flash flash-error mb-6" style="display: none;"></div>

    <!-- Runs list -->
    <div id="runs-list" class="stream-container" style="display: none;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const slug = '{{ kit.slug }}';
    const kitName = '{{ kit.name }}';

    document.addEventListener('DOMContentLoaded', loadHistory);

    function loadHistory() {
        fetch('/api/kits/' + slug + '/executions')
            .then(function (resp) { return resp.json(); })
            .then(function (data) {
                document.getElementById('loading-state').style.display = 'none';

                if (data.error) {
                    const errEl = document.getElementById('error-state');
                    errEl.textContent = data.error;
                    errEl.style.display = 'block';
                    return;
                }

                if (!data.runs || data.runs.length === 0) {
                    document.getElementById('empty-state').style.display = 'block';
                    return;
                }

                renderRuns(data.runs);
            })
            .catch(function (err) {
                document.getElementById('loading-state').style.display = 'none';
                const errEl = document.getElementById('error-state');
                errEl.textContent = 'Failed to load history: ' + err.message;
                errEl.style.display = 'block';
            });
    }

    function renderRuns(runs) {
        const container = document.getElementById('runs-list');
        container.style.display = 'flex';
        container.innerHTML = '';

        runs.forEach(function (run, idx) {
            const card = document.createElement('a');
            card.href = '/kit/' + slug + '/history/' + run.id;
            card.className = 'card card-hoverable fade-in';
            card.style.textDecoration = 'none';
            card.style.color = 'inherit';
            card.style.display = 'block';
            card.style.animationDelay = (idx * 0.04) + 's';

            const startDate = run.started_at ? new Date(run.started_at) : null;
            const dateStr = startDate ? formatDate(startDate) : 'Unknown date';
            const timeStr = startDate ? formatTime(startDate) : '';

            const label = run.label || (kitName + ' — ' + dateStr);
            const statusBadge = getStatusBadge(run.status);

            let metaParts = [];
            metaParts.push(run.total_steps + ' step' + (run.total_steps !== 1 ? 's' : ''));
            metaParts.push(run.storage_mode);
            if (run.completed_at && run.started_at) {
                const duration = Math.round((new Date(run.completed_at) - new Date(run.started_at)) / 1000);
                if (duration < 60) {
                    metaParts.push(duration + 's');
                } else {
                    metaParts.push(Math.floor(duration / 60) + 'm ' + (duration % 60) + 's');
                }
            }

            card.innerHTML =
                '<div style="padding: 1.125rem 1.25rem; display: flex; align-items: center; justify-content: space-between;">' +
                '<div style="flex: 1; min-width: 0;">' +
                '<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.375rem;">' +
                '<span class="font-medium" style="font-size: 1rem;">' + escapeHtml(label) + '</span>' +
                statusBadge +
                '</div>' +
                '<div class="text-xs text-muted-foreground" style="display: flex; align-items: center; gap: 0.5rem;">' +
                '<span>' + dateStr + (timeStr ? ' at ' + timeStr : '') + '</span>' +
                '<span>·</span>' +
                '<span>' + metaParts.join(' · ') + '</span>' +
                '</div>' +
                (run.error_message ? '<div class="text-xs" style="color: #991b1b; margin-top: 0.25rem;">' + escapeHtml(run.error_message) + '</div>' : '') +
                '</div>' +
                '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--color-muted-foreground); flex-shrink: 0; margin-left: 1rem;">' +
                '<polyline points="9 18 15 12 9 6"></polyline>' +
                '</svg>' +
                '</div>';

            container.appendChild(card);
        });
    }

    function getStatusBadge(status) {
        if (status === 'completed') {
            return '<span class="badge" style="background: #f0fdf4; color: #166534; border-color: #bbf7d0;">Completed</span>';
        } else if (status === 'failed') {
            return '<span class="badge" style="background: #fef2f2; color: #991b1b; border-color: #fecaca;">Failed</span>';
        } else {
            return '<span class="badge" style="background: #eff6ff; color: #1e40af; border-color: #bfdbfe;">Running</span>';
        }
    }

    function formatDate(d) {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
    }

    function formatTime(d) {
        return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
</script>
{% endblock %}